# BookSearch

![coverage](https://img.shields.io/badge/coverage-97%25-brightgreen)

Приложение по поиску книг с расширенным фильтром поискового запроса.

В данный момент оперирует открытой информацией с litres.ru.

# Production

В настоящий момент приложение развернуто для публичного доступа:

[ссылка](http://95.163.242.214/)

IP адрес:
`95.163.242.214`

# Описание приложения

Приложение парсит (анализирует и забирает) книжную информацию из "партнерских" БД (находятся в открытом доступе, делятся на "простые" и "детализированные") и с отдельных интернет страниц.

Т.к. одни и те же вещи (например, жанр) могут называться во всех источниках по-разному, то, для получения полноценной информации об одной книге, нужно предварительно извлечь книжную информацию из обеих "партнерских" БД (сначала из "простой", потом из "детализированной") и, используя ссылку на книгу, совершить парсинг удаленной страницы и докачать недостающую информацию.

Ввиду того, то сайт litres агрессивно защищает себя от роботов при помощи ddos-guard, приложение недостающую информацию по оценкам, количеству страниц и комментариев просто генерирует, а удаленный парсинг изначально отключен.

По этой причине приложение штатно разворачивается с ограниченным количеством книг.

Приложение не хранит у себя сами книги (fb2, txt и т.п.) или их описания.

# Устройство приложения

Для парсинга данных (локального и удаленного) написан сервис Worker.

При разворачивании приложения он отвечает за начальную загрузку данных в БД из скачиваемых "партнерских" БД, а, при его использовании в качестве удаленного парсера, обрабатывает не более 1 задачи (интернет страницы) одновременно не чаще 1 раза в секунду.

Незарегистрированному пользователю доступна функция поиска книг.

Книги можно искать или по фильтру(ам) (жанр, год издания, дата добавления на сайт и т.д.), в этом случае результаты поиска будут выведены постранично с паджинацией и разбивкой по дням добавления на сайт, или можно искать конкретную книгу или автора, в этом случае будет осуществлен полнотекстовый поиск (Sphinx) и выведено ограниченное количество результатов на одну страницу.

Регистрация (аутентификация - Devise) осуществляется или через указание электронной почты, на которую потом придет письмо с подтверждением, или при помощи аккаунта GitHub, у которого будет запрошен актуальный адрес электронной почты.

Зарегистрированный пользователь (авторизация - Cancancan) может:
- сохранить информацию о книге на свою книжную полку
- сбросить сохраненные книги и их авторов на почту (списком)
- воспользоваться параметрами сделанного ранее поиска, чтобы совершить новый поиск
- совершать операции со своим аккаунтом (изменение, удаление)

Письма рассылаются через почту Gmail (SMTP).

Данные, касающиеся книг и авторов, пробрасываются на фронт как JSON и далее обрабатываются при помощи JS/Jquery и шаблонов Handlebars.

Модели, контроллеры, сервисы и пользовательский интерфейс покрыты тестами (RSpec).

В качестве CSS-фреймворка подключен Bootstrap.

# API

В приложении реализован доступ к API по усеченной схеме аутентификации Authorization Code Flow (OAuth 2.0).

Зарегистрированный пользователь может перейти в Профиль -> Управление доступом к API и запросить код доступа при помощи кнопки Запросить код доступа. В ответ приложение выдаст ему код доступа (access token), действующий в течение 12 часов, который необходимо указывать в запросе при каждом обращении к API.

## Полнотекстовый поиск

По названия книг и именам авторов доступен полнотекстовый поиск со встроенным распознаванием отдельных или неполных слов и игнорированием верхнего/нижнего регистра.

Для использования полнотекстового поиска необходимо выполнить GET запрос:
```
http://application_ip:80/api/v1/searches/full_text.json?<параметры>
```
, где `application_ip` - IP приложения из раздела **Production**.

Пары ключ-значение, используемые в параметрах запроса:
- `query` - строка для поиска, обязательный параметр,
- `access_token` - код доступа, обязательный параметр.

Пример запроса:
```
http://application_ip:80/api/v1/searches/full_text.json?query=рубеж&access_token=vkOaly1nxlYqemM6Jebm_8dhbjE6XskzycVfp3sPPJk
```
, где:
- значение `рубеж` ключа `query` является искомой строкой,
- значение `vkOaly1nxlYqemM6Jebm_8dhbjE6XskzycVfp3sPPJk` ключа `access_token` является уникальным кодом доступа пользователя.

В ответ приложение вернет данные в формате JSON:
```
{
  "books": [
    {
      "book": {
        "id": 18562,
        "int_id": "319572",
        "name": "За рубежом",
        "writing_year": 1881,
        "authors": [
          {
            "id": 1983,
            "name": "Михаил Евграфович Салтыков-Щедрин",
            "url": "mihail-saltykov-schedrin/"
          }
        ],
      }
    },
    {
      "book": {
        "id": 7037,
        "int_id": "159636",
        "name": "Замуж за иностранца, или Русские жены за рубежом",
        "writing_year": 2007,
        "authors": [
          {
            "id": 81,
            "name": "Юлия Витальевна Шилова",
            "url": "uliya-shilova/"
          }
        ],
      }
    },
  ...
  ]
}
```
, где:
- `books` и `authors` - массивы с книгами и авторами соответственно,
- `book` - ключ, значением которого являются данные на конкретную книгу,
- `id` - внутренний идентификатор ресурса,
- `int_id` - внутренний идентификатор ресурса litres.ru,
- `name` - название книги или имя автора,
- `writing_year` - год издания книги,
- `url` - ссылка на автора на litres.ru.

В случае, если строка запроса не соответствует определенным критериям, в ответном JSON будет возвращен ключ warning, содержащий хэш с данными. В зависимости от критерия, хэш будет содержать ключи:
- `query_length_data` - если строка запроса содержит слишком мало или слишком много символов,
- `restricted_chars` - если строка содержит запрещенные символы.

Если приложение не найдет ни одного совпадения, то будет возращен JSON, содержащий пустой хэш, со статусом ответа 200.

## Поиск с применением фильтров

Для поиска книг, которые были опубликованы за определенный период или для которых должно быть выполнено особое условие (например - количество комментариев не менее некоторого значения), доступен поиск с применением фильтров.

Для использования полнотекстовго поиска необходимо выполнить GET запрос:
```
http://application_ip:80/api/v1/searches/with_filters.json?<параметры>
```

Пары ключ-значение, используемые в запросе:
- `genre_int_id` - внутренний идентификатор жанра litres.ru (например, "5073" - "научная фантастика"),
- `start_date_added(2i)` - месяц публикации книги на litres.ru, не менее, включительно; ключи `start_date_added(2i)` и `start_date_added(1i)` применяются только совместно,
- `start_date_added(1i)` - год публикации книги, не менее, включительно; ключи `start_date_added(2i)` и `start_date_added(1i)` применяются только совместно,
- `end_date_added(2i)` - месяц публикации книги, не более, включительно; ключи `end_date_added(2i)` и `end_date_added(1i)` применяются только совместно,
- `end_date_added(1i)` - год публикации книги, не более, включительно; ключи `end_date_added(2i)` и `end_date_added(1i)` применяются только совместно,
- `rating_litres_average` - средний рейтинг litres.ru, не менее, включительно,
- `rating_litres_votes_count` - количество оценок litres.ru, не менее, включительно,
- `rating_livelib_average` - средний рейтинг livelib.ru, не менее, включительно,
- `rating_livelib_votes_count` - количество оценок livelib.ru, не менее, включительно,
- `writing_year` - год написания книги, не менее, включительно,
- `pages_count` - количество страниц, не менее, включительно,
- `comments_count` - количество комментариев, не менее, включительно,
- `page` - номер страницы (ресурсы возвращаются постранично), целое положительное число или 0,
- `access_token` - код доступа, обязательный параметр.

Пример запроса:
```
http://application_ip:80/api/v1/searches/with_filters.json?start_date_added(2i)=10&start_date_added(1i)=2008&end_date_added(2i)=4&end_date_added(1i)=2009&writing_year=1980&comments_count=25&access_token=vkOaly1nxlYqemM6Jebm_8dhbjE6XskzycVfp3sPPJk
```
, где:
- `start_date_added(2i)=10&start_date_added(1i)=2008` - дата публикации книг на litres.ru, 10 месяц 2008 года, не менее, включительно (поиск по дням месяца не осуществляется),
- `end_date_added(2i)=4&end_date_added(1i)=2009` - дата публикации книг, 4 месяц 2009 года, не более, включительно,
- `writing_year=1980` - год написания книг, 1980, не менее, включительно,
- `comments_count=25` - количество комментариев, 25, не менее, включительно.

В ответ приложение вернет данные в формате JSON:
```
{
  "results": {
    "count": 53,
    "per_page": 25
  },
  "books": [
    {
      "book": {
        "id": 814,
        "int_id": "121115",
        "name": "Идеальный враг",
        "date": "2009-04-29T00:00:00.000+04:00",
        "writing_year": 2009,
        "pages_count": 513,
        "comments_count": 39,
        "authors": [
          {
            "id": 1262,
            "name": "Михаил Кликин",
            "url": "mihail-klikin/"
          }
        ],
        "genres": [
          {
            "id": 60,
            "int_id": "5074",
            "name": "Боевая фантастика"
          }
        ],
        "litres_book_rating": null,
        "livelib_book_rating": null
      }
    },
    {
      "book": {
        "id": 15080,
        "int_id": "180356",
        "name": "Общая теория статистики",
        "date": "2009-04-21T00:00:00.000+04:00",
        "writing_year": 2008,
        "pages_count": 402,
        "comments_count": 48,
        "authors": [
          {
            "id": 1195,
            "name": "Лидия Владимировна Щербина",
            "url": "lidiya-scherbina/"
          }
        ],
        "genres": [
          {
            "id": 365,
            "int_id": "6457",
            "name": "Книги по экономике"
          }
        ],
        "litres_book_rating": {
          "rating_id": 1,
          "average": 6.8,
          "votes_count": 10
        },
        "livelib_book_rating": null
      }
    },
  ...
  ]
}
```
, где:
- `results` - хэш содержит в себе ключи count и per_page, означающие количество найденных ресурсов и количество выдаваемых ресурсов на страницу за один запрос соответственно,
- `books`, `authors`, `genres` - массивы книг, авторов и жанров соответственно,
- `book` - ключ, значением которого являются данные на конкретную книгу,
- `id` - внутренний идентификатор ресурса,
- `int_id` - внутренний идентификатор ресурса litres.ru,
- `name` - название книги или имя автора,
- `date` - дата публикация книги на litres.ru,
- `writing_year` - год издания книги,
- `pages_count` - количество страниц,
- `comments_count` - количество комментариев,
- `litres_book_rating` и `livelib_book_rating` - хэши с ключами average и votes_count, означающие среднюю оценку и количество проголосовавших соответственно, rating_id содержит внутренний идентификатор сайтов,
- `url` - ссылка на автора на litres.ru.

В случае, если в параметры запроса включен ключ `page` со значением страницы, будут возвращены только ресурсы без ключа `results`.

Пример:

```
http://application_ip:80/api/v1/searches/with_filters.json?start_date_added(2i)=10&start_date_added(1i)=2008&end_date_added(2i)=4&end_date_added(1i)=2009&writing_year=1980&comments_count=25&page=1&access_token=vkOaly1nxlYqemM6Jebm_8dhbjE6XskzycVfp3sPPJk
```

Все запросы без ключа `page` или с параметром `&page=&` (без значения) делаются для страницы номер 0.

В случае, если строка запроса не соответствует определенным критериям, в ответном JSON будет возвращен ключ warning, содержащий хэш с данными. В зависимости от критерия, хэш будет содержать ключи:
- `genre` - если не найден указанный жанр,
- `date_added_data` - если неверно указана начальная или конечная дата публикации книг.

Если приложение не найдет ни одного совпадения, то будет возращен JSON, содержащий пустой хэш с ключом `results` (или просто пустой хэш, если был задан ключ `page` со значением), со статусом ответа 200.

## Работа с API

Для работы с API необходимо написать свое приложение или использовать стороннее приложение.

Т.к. это REST GET запросы на порт 80, то запрос, отправленный при помощи обычного браузера, тоже будет обработан. При наличии действующего кода доступа будет возвращен список книг и авторов в формате JSON, при недействительном коде доступа - ошибка 401.

# Технические данные

Написано на Ruby 3.0.5, Rails 6.1.7.4.

# Разворачивание приложения

Для начального разворачивания приложения написан LimitedWorkerJob, который формирует задачи (WorkerTask) для сервиса Worker и запускает его на выполнение.

В окружении development:
```console
bundle exec bin/rails runner -e development LimitedWorkerJob.perform_now
```

В окружении production:
```console
bundle exec bin/rails runner -e production LimitedWorkerJob.perform_now
```

После вызова сервис Worker скачает, пропарсит и удалит "партнерские" БД (размер одной скачанной и распакованной "партнерской" БД может быть более 3.5 ГБ), недостающие данные будут сгенерированы.

Для полноценной работы приложения также должна быть настроена БД, в credentials указаны необходимые данные для Gmail, GitHub и запущены Sphinx, Redis, Sidekiq.
